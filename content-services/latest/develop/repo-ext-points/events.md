---
title: Events Extension Point
---

When implementing business logic an out-of-process model should be used. For example, if some processing should be done
every time a PDF is uploaded to a specific folder, then there is an event that can be subscribed to and the business logic 
can be implemented in an external process separate from the Content Services server process.

Architecture Information: [Platform Architecture]({% link content-services/latest/develop/software-architecture.md %}#platformarch)

## Event Model

The event model in Content Services is a library packaged as a JAR file, which is part of the repository (i.e. `alfresco.war`). 
The library contains the event model and the databind helpers used to help the clients to marshall and unmarshall the events.

The event model is based on the [CloudEvents specification](https://github.com/cloudevents/spec/blob/v1.0/spec.md){:target="_blank"}.
CloudEvents is a specification for describing event data in common formats to provide interoperability across services, 
platforms and systems. For more information see [CloudEvents Primer](https://github.com/cloudevents/spec/blob/v1.0/primer.md){:target="_blank"}.

The Content Services event payload (i.e. the part of transmitted data that is the actual intended message) consist
of two parts. The CloudEvent attributes and the Content Services event attributes.

```json
{
  CloudEvent standard attributes...
  "data": {
    Content Services custom event attributes... 
  }

}
```

Basic configuration of the event system is in the [repository.properties](https://github.com/Alfresco/alfresco-community-repo/blob/master/repository/src/main/resources/alfresco/repository.properties){:target="_blank"}
file:

```text
### Repository events2
#
# Type and aspect filters which should be excluded.
# Note: System folder node types are added by default.
repo.event2.filter.nodeTypes=sys:*, fm:*, cm:thumbnail, cm:failedThumbnail, cm:rating, rma:rmsite include_subtypes
repo.event2.filter.nodeAspects=sys:*
repo.event2.filter.childAssocTypes=rn:rendition
#
# Comma separated list of users which should be excluded
# Note: username's case-sensitivity depends on the {user.name.caseSensitive} setting
repo.event2.filter.users=System, null
#
# Topic name
repo.event2.topic.endpoint=amqp:topic:alfresco.repo.event2
```                                                 

Any custom configuration, to for example the default event filtering, can be done in `alfresco-global.properties`.

### CloudEvent attributes

Standard CloudEvent attributes in the context of Content Services events:

| Property             | Type          | Description                                                      |
|----------------------|---------------|------------------------------------------------------------------|
|`type`                |String         |The [Alfresco event type](#acseventtypes). ([1.0 spec#type](https://github.com/cloudevents/spec/blob/v1.0/spec.md#type){:target="_blank"})|
|`specversion`         |String         |The CloudEvents specification version. Value should be `1.0`. ([1.0 spec#specversion](https://github.com/cloudevents/spec/blob/v1.0/spec.md#specversion){:target="_blank"})|
|`id`                  |String         |Event ID, a UUID generated by the producer ([1.0 spec#id](https://github.com/cloudevents/spec/blob/v1.0/spec.md#id){:target="_blank"})|
|`source`              |URI-reference  |The instance of a repository that produced the event, .i.e. repository cluster node identifier ([1.0 spec#source](https://github.com/cloudevents/spec/blob/v1.0/spec.md#source){:target="_blank"})|
|`time`                |Timestamp      |The producer's timestamp of when the event occurred. ([1.0 spec#time](https://github.com/cloudevents/spec/blob/v1.0/spec.md#time){:target="_blank"})|
|`dataschema`          |URI-reference  |Identifies the schema that data adheres to.|
|`datacontenttype`     |String         |The content type of the data attribute. Value should be `application/json`. ([1.0 spec#datacontenttype](https://github.com/cloudevents/spec/blob/v1.0/spec.md#datacontenttype){:target="_blank"})|
|`data`                |JSON           |The domain-specific [data](#acsdata) of the event. ([1.0 spec#data](https://github.com/cloudevents/spec/blob/v1.0/spec.md#data-attribute){:target="_blank"})|

### Content Services event data attributes {#acsdata}

Content Services event data payload/attributes:

| Property             | Type          | Description                                                      |
|----------------------|---------------|------------------------------------------------------------------|
|`data.eventGroupId`   |String         |Optional unique identifier for events group, i.e. a transaction ID. Multiple nodes can be created in the same transaction.|
|`data.resource`       |Object (varies)|The object representing the resource affected. Here the resource represents a node in the Alfresco Repository.|
|`data.resourceBefore` |Object (varies)|The object representing the old values of the changed resource's attributes. Note, this object is only available on the `org.alfresco.event.node.Updated` event type.|
|`data.resource.@type` |String|The type of resource object, such as an Alfresco Repository `NodeResource`.|
|`data.resource.id`    |String|The Alfresco Repository Node Id for the resource (e.g. node such as folder or file) that the data represent.|
|`data.resource.primaryHierarchy` |Array|Optional primary hierarchy of ancestors of the resource affected, i.e. folder path for the node. Note that the first element is the immediate parent.|
|`data.resource.name`             |String|The name of the resource. This is the name of the node, e.g. the name of a folder or a file.|
|`data.resource.nodeType`         |String|A content model type, such as `cm:content` for a file or `cm:folder` for a folder. See [content modelling]({% link content-services/latest/develop/repo-ext-points/content-model.md %})|
|`data.resource.createdByUser`    |Object|The id (String) and display name (String) of the user that created the node.|
|`data.resource.createdAt`        |String|The time a node was created.|
|`data.resource.modifiedByUser`   |Object|The id (String) and display name (String) of the user that modified/updated the node.|
|`data.resource.modifiedAt`       |String|The time a node was modified/updated.|
|`data.resource.content`          |Object|If the node is of content type `cm:content` (i.e. a file), then this object contains information about the file, such as MIME-type and size.|
|`data.resource.properties`       |Object|[Content model]({% link content-services/latest/develop/repo-ext-points/content-model.md %}) properties corresponding to the `data.resource.nodeType`.|
|`data.resource.aspectNames`      |Array|[Content model]({% link content-services/latest/develop/repo-ext-points/content-model.md %}) aspects that have been applied to the node.|
|`data.resource.isFolder`         |Boolean|`true` if this node is of type `cm:folder`.|
|`data.resource.isFile`           |Boolean|`true` if this node is of type `cm:content`.|
|`data.resource.resourceReaderAuthorities`|Array|Authorities that can read this resource, such as `GROUP_EVERYONE`, which means anybody can read the data.|
|`data.resource.resourceDeniedAuthorities`|Array|Authorities that cannot access this data.|

For a detailed view of the event data refer to [Repo Event JSON schema](https://github.com/Alfresco/acs-event-model/tree/master/src/main/resources/json-schema){:target="_blank"}.

### Content Services event types {#acseventtypes}

The following are the different types of events that can be subscribed to:

| Name                              | Description                                                      |
|-----------------------------------|------------------------------------------------------------------|
| `org.alfresco.event.node.Created` | Occurs when a node is created |
| `org.alfresco.event.node.Updated` | Occurs when a node is updated or moved. Currently only node's name, type, properties, aspects, and content are supported|
| `org.alfresco.event.node.Deleted` | Occurs when a node is deleted |
| `org.alfresco.event.assoc.child.Created` | Occurs when a secondary child association is created |
| `org.alfresco.event.assoc.child.Deleted` | Occurs when a secondary child association is deleted |
| `org.alfresco.event.assoc.peer.Created` | Occurs when a peer association is created |
| `org.alfresco.event.assoc.peer.Deleted` | Occurs when a peer association is deleted |

## Event descriptions

Let's have a look at each event and see what we can use it for when implementing business logic for a 
particular content domain.

### Node created event

This event is fired whenever a node, such as a folder or file, is created in the repository. The full name of this 
event is `org.alfresco.event.node.Created`. Here is and example payload for this event type:

```json
{
  "specversion": "1.0",
  "type": "org.alfresco.event.node.Created",
  "id": "368818d9-dddd-4b8b-8eab-e050253d7f61",
  "source": "/08d9b620-48de-4247-8f33-360988d3b19b",
  "time": "2021-01-21T11:14:16.42372Z",
  "dataschema": "https://api.alfresco.com/schema/event/repo/v1/nodeCreated",
  "datacontenttype": "application/json",
  "data": {
    "eventGroupId": "4004ca99-9d2a-400d-9d80-8f840e223581",
    "resource": {
      "@type": "NodeResource",
      "id": "d71dd823-82c7-477c-8490-04cb0e826e65",
      "primaryHierarchy": [
        "5f355d16-f824-4173-bf4b-b1ec37ef5549",
        "93f7edf5-e4d8-4749-9b4c-e45097e2e19d",
        "c388532e-8da6-4d50-a6d2-4f3f3ac36ff7",
        "2fa2cde5-9d83-4460-a38c-cfe4ec9cca08" 
      ],
      "name": "purchase-order-scan.pdf",
      "nodeType": "cm:content",
      "createdByUser": {
        "id": "admin",
        "displayName": "Administrator"
      },
      "createdAt": "2021-01-21T11:14:15.695Z",
      "modifiedByUser": {
        "id": "admin",
        "displayName": "Administrator"
      },
      "modifiedAt": "2021-01-21T11:14:15.695Z",
      "content": {
        "mimeType": "application/pdf",
        "sizeInBytes": 531152,
        "encoding": "UTF-8"
      },
      "properties": {
        "cm:autoVersion": true,
        "cm:versionType": "MAJOR",
        "cm:autoVersionOnUpdateProps": false,
        "cm:versionLabel": "1.0",
        "cm:initialVersion": true
      },
      "aspectNames": [
        "cm:versionable",
        "cm:auditable"
      ],
      "isFolder": false,
      "isFile": true
    },
    "resourceReaderAuthorities": [
      "GROUP_EVERYONE"
    ],
    "resourceDeniedAuthorities": []
  }
}
```

Using the [Node Browser]({% link content-services/latest/admin/troubleshoot.md %}#usingnodebrowser) the following `NodeRefs` were resolved as follows:

```json
      "id": "d71dd823-82c7-477c-8490-04cb0e826e65",   /app:company_home/cm:Testing/cm:Inbound/cm:purchase-order-scan.pdf (cm:content)
      "primaryHierarchy": [
        "5f355d16-f824-4173-bf4b-b1ec37ef5549",       /app:company_home/cm:Testing/cm:Inbound  (cm:folder)
        "93f7edf5-e4d8-4749-9b4c-e45097e2e19d",       /app:company_home/cm:Testing             (cm:folder)
        "c388532e-8da6-4d50-a6d2-4f3f3ac36ff7",       /app:company_home                        (cm:folder)
        "2fa2cde5-9d83-4460-a38c-cfe4ec9cca08"        Store root                               (sys:store_root)
```

The event payload is telling us that a file called `purchase-order-scan.pdf` (i.e. `data.resource.name`) of type `cm:content` 
(i.e. `data.resource.nodeType`) was uploaded by the user `admin` (i.e. `data.resource.createdByUser.id`) to the 
**/Company Home/Testing/Inbound** folder (i.e. `data.resource.primaryHierarchy[0]`). The new node has a Node ID 
`d71dd823-82c7-477c-8490-04cb0e826e65` (i.e. `data.resource.id`).

To find out the display name for a folder or file via its Node ID use the [ReST API]({% link content-services/latest/develop/rest-api-guide/folders-files.md %}#getnodemetadata).

When subscribing to the `org.alfresco.event.node.Created` event it's possible to filter out anything that is
of no interest. So for example, if you are interested in files with content type `cm:content` uploaded to a folder 
called **/Company Home/Testing/Inbound** (e.g. Node ID `5f355d16-f824-4173-bf4b-b1ec37ef5549`) it would be easy to 
configure this. The following code snippet shows how this could be done with an 
[Apache Camel route](https://camel.apache.org/manual/latest/routes.html){:target="_blank"} configuration:

```java
public class SimpleRoute extends RouteBuilder {

    @Override
    public void configure() {

        from("amqpConnection:topic:alfresco.repo.event2")
            .id("NewFilesRoute")
            .log("${body}") 
            .choice() 
            .when() 
                .jsonpath("$[?(@.type=='org.alfresco.event.node.Created' && " +
                        "@.data.resource.nodeType=='cm:content' && " +
                        "'5f355d16-f824-4173-bf4b-b1ec37ef5549' in @.data.resource.primaryHierarchy[:1])]") 
            .unmarshal("publicDataFormat") 
            .bean("eventHandlerImpl", "onReceive(*, COPY)") 
            .end();
    }
}
```

Content Services events are published on the [JMS Topic](http://activemq.apache.org/how-does-a-queue-compare-to-a-topic.html){:target="_blank"} 
called `alfresco.repo.event2`. See/search default configuration in the [repository.properties](https://github.com/Alfresco/alfresco-community-repo/blob/master/repository/src/main/resources/alfresco/repository.properties){:target="_blank"} file.
So the Camel Route is configured to pick up events from `amqpConnection:topic:alfresco.repo.event2`. The `amqpConnection` to the 
Active MQ endpoint in the Content Services server is implemented as follows:

```java
public class RouteConfig
{
    @Value("${alfresco.events.broker.activemq.url}")
    private String activemqUrl;

    @Bean
    public DataFormat publicDataFormat()
    {
        return new JacksonDataFormat(ObjectMapperFactory.createInstance(), RepoEvent.class);
    }

    @Bean
    public AMQPComponent amqpConnection()
    {
        JmsConnectionFactory jmsConnectionFactory = new JmsConnectionFactory();
        jmsConnectionFactory.setRemoteURI(activemqUrl);

        CachingConnectionFactory cachingConnectionFactory = new CachingConnectionFactory();
        cachingConnectionFactory.setTargetConnectionFactory(jmsConnectionFactory);

        JmsConfiguration jmsConfiguration = new JmsConfiguration();
        jmsConfiguration.setConnectionFactory(cachingConnectionFactory);
        // Other JMS config if required e.g.:
        // jmsConfiguration.setCacheLevelName("CACHE_CONSUMER");

        return new AMQPComponent(jmsConfiguration);
    }
}
``` 

The `alfresco.events.broker.activemq.url` property is configured with the `amqp://localhost:5672` value in a properties file.


```

 